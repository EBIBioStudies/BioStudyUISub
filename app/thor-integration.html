<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>Thor Integration</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="https://www.ebi.ac.uk/europepmc/thor/resources/js/datasubmission/ebithor-submission.1.0.0.js"></script>
</head>
<body>
<form id="thorForm" name="thorForm">
    <input type="text"
           id="username"
           name="username"
           tabindex="1"
           class="thorCompleteNameTx"/>
    <input type="email"
           id="email"
           name="email"
           class="thorEmailTxt"/>
    <input type="text" id="orcId" name="orcId" class="thorOrcIdIdentifier"/>
    <span class="thorOrcIdSpan"></span>
</form>
</body>
<script>
    var __bsstThor__ = null;
    var __bsstCallback__ = null;

    function bsst_thorListener(msg) {
        console.log("bsst_thorListener(...)");

        if (msg === 'openPopup') {
            bsst_openOrcidPopup(function (msg) {
                if (parent) {
                    console.log("sending message to parent");
                    parent.sendMessage({thor:msg}, '*');
                }
            });
            return;
        }

        if (!__bsstThor__) {
            console.log("bsst_thorListener() error: not initialized");
            return;
        }

        __bsstThor__.searchOrcIdBio(function (msg) {
            if (__bsstCallback__) {
                __bsstCallback__(msg);
                __bsstCallback__ = null;
            }
        });
    }

    function bsst_openOrcidPopup(callback) {
        if (!__bsstThor__) {
            bsst_initThor();
        }
        __bsstCallback__ = callback;
        __bsstThor__.openOrcidPopup(0);
    }

    function bsst_initThor() {
        if (__bsstThor__ != null) {
            console.log("bsst_initThor(): already initialized");
            return;
        }

        function removeMessageListener(listener, capture) {
            if (window.removeEventListener) {
                console.log("removeEventListener(...)");
                window.removeEventListener("message", listener, capture);
            }
            if (window.detachEvent) {
                console.log("detachEvent(...)");
                window.detachEvent("onmessage", listener);
            }
        }

        function addMessageListener(listener, capture) {
            if (window.addEventListener) {
                console.log("addEventListener(...)");
                addEventListener("message", listener, capture);
            }
            if (window.attachEvent) {
                console.log("attachEvent(...)");
                attachEvent("onmessage", listener);
            }
        }

        if (thorListener) {
            removeMessageListener(thorListener, false);
        } else {
            console.log("warning: no thorListener found");
        }

        if (thorApplicationNamespace) {
            addMessageListener(bsst_thorListener, false);
            __bsstThor__ = thorApplicationNamespace;
        } else {
            console.log("warning: no thorApplicationNamespace found");
        }
    }

</script>